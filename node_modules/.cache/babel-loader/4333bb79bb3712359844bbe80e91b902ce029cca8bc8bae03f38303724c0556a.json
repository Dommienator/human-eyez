{"ast":null,"code":"import { supabase } from \"./supabase\";\nimport { sendVerificationCode } from \"./email\";\nconst generateCode = () => {\n  return Math.floor(100000 + Math.random() * 900000).toString();\n};\nexport const createVerificationCode = async (email, type = \"email_verification\") => {\n  const code = generateCode();\n  const expiresAt = new Date();\n  expiresAt.setMinutes(expiresAt.getMinutes() + 10);\n  const {\n    data,\n    error\n  } = await supabase.from(\"verification_codes\").insert([{\n    email,\n    code,\n    type,\n    expires_at: expiresAt.toISOString(),\n    used: false\n  }]).select().single();\n  if (error) {\n    console.error(\"Error creating verification code:\", error);\n    return {\n      success: false,\n      error\n    };\n  }\n  return {\n    success: true,\n    code,\n    data\n  };\n};\nexport const verifyCode = async (email, code, type = \"email_verification\") => {\n  const {\n    data,\n    error\n  } = await supabase.from(\"verification_codes\").select(\"*\").eq(\"email\", email).eq(\"code\", code).eq(\"type\", type).eq(\"used\", false).gt(\"expires_at\", new Date().toISOString()).order(\"created_at\", {\n    ascending: false\n  }).limit(1).single();\n  if (error || !data) {\n    return {\n      success: false,\n      message: \"Invalid or expired code\"\n    };\n  }\n  await supabase.from(\"verification_codes\").update({\n    used: true\n  }).eq(\"id\", data.id);\n  return {\n    success: true\n  };\n};\nexport const resendVerificationCode = async (email, userName, type = \"email_verification\") => {\n  const tenMinutesAgo = new Date();\n  tenMinutesAgo.setMinutes(tenMinutesAgo.getMinutes() - 10);\n  const {\n    data: recentCodes\n  } = await supabase.from(\"verification_codes\").select(\"id\").eq(\"email\", email).eq(\"type\", type).gte(\"created_at\", tenMinutesAgo.toISOString());\n  if (recentCodes && recentCodes.length >= 3) {\n    return {\n      success: false,\n      message: \"Too many attempts. Please wait 10 minutes.\"\n    };\n  }\n  const result = await createVerificationCode(email, type);\n  if (!result.success) {\n    return result;\n  }\n  await sendVerificationCode(email, userName, result.code);\n  return {\n    success: true,\n    message: \"Verification code sent!\"\n  };\n};","map":{"version":3,"names":["supabase","sendVerificationCode","generateCode","Math","floor","random","toString","createVerificationCode","email","type","code","expiresAt","Date","setMinutes","getMinutes","data","error","from","insert","expires_at","toISOString","used","select","single","console","success","verifyCode","eq","gt","order","ascending","limit","message","update","id","resendVerificationCode","userName","tenMinutesAgo","recentCodes","gte","length","result"],"sources":["D:/Kazi Strong/HumanEyez/src/services/verification.js"],"sourcesContent":["import { supabase } from \"./supabase\";\r\nimport { sendVerificationCode } from \"./email\";\r\n\r\nconst generateCode = () => {\r\n  return Math.floor(100000 + Math.random() * 900000).toString();\r\n};\r\n\r\nexport const createVerificationCode = async (\r\n  email,\r\n  type = \"email_verification\",\r\n) => {\r\n  const code = generateCode();\r\n  const expiresAt = new Date();\r\n  expiresAt.setMinutes(expiresAt.getMinutes() + 10);\r\n\r\n  const { data, error } = await supabase\r\n    .from(\"verification_codes\")\r\n    .insert([\r\n      {\r\n        email,\r\n        code,\r\n        type,\r\n        expires_at: expiresAt.toISOString(),\r\n        used: false,\r\n      },\r\n    ])\r\n    .select()\r\n    .single();\r\n\r\n  if (error) {\r\n    console.error(\"Error creating verification code:\", error);\r\n    return { success: false, error };\r\n  }\r\n\r\n  return { success: true, code, data };\r\n};\r\n\r\nexport const verifyCode = async (email, code, type = \"email_verification\") => {\r\n  const { data, error } = await supabase\r\n    .from(\"verification_codes\")\r\n    .select(\"*\")\r\n    .eq(\"email\", email)\r\n    .eq(\"code\", code)\r\n    .eq(\"type\", type)\r\n    .eq(\"used\", false)\r\n    .gt(\"expires_at\", new Date().toISOString())\r\n    .order(\"created_at\", { ascending: false })\r\n    .limit(1)\r\n    .single();\r\n\r\n  if (error || !data) {\r\n    return { success: false, message: \"Invalid or expired code\" };\r\n  }\r\n\r\n  await supabase\r\n    .from(\"verification_codes\")\r\n    .update({ used: true })\r\n    .eq(\"id\", data.id);\r\n\r\n  return { success: true };\r\n};\r\n\r\nexport const resendVerificationCode = async (\r\n  email,\r\n  userName,\r\n  type = \"email_verification\",\r\n) => {\r\n  const tenMinutesAgo = new Date();\r\n  tenMinutesAgo.setMinutes(tenMinutesAgo.getMinutes() - 10);\r\n\r\n  const { data: recentCodes } = await supabase\r\n    .from(\"verification_codes\")\r\n    .select(\"id\")\r\n    .eq(\"email\", email)\r\n    .eq(\"type\", type)\r\n    .gte(\"created_at\", tenMinutesAgo.toISOString());\r\n\r\n  if (recentCodes && recentCodes.length >= 3) {\r\n    return {\r\n      success: false,\r\n      message: \"Too many attempts. Please wait 10 minutes.\",\r\n    };\r\n  }\r\n\r\n  const result = await createVerificationCode(email, type);\r\n\r\n  if (!result.success) {\r\n    return result;\r\n  }\r\n\r\n  await sendVerificationCode(email, userName, result.code);\r\n\r\n  return { success: true, message: \"Verification code sent!\" };\r\n};\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}